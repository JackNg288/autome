name: MEXC Bot - Docker (100% Reliable TA-Lib)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  trading-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create optimized Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM python:3.11-slim
        
        # Install system dependencies in one layer
        RUN apt-get update && apt-get install -y \
            build-essential \
            wget \
            curl \
            && rm -rf /var/lib/apt/lists/*
        
        # Install TA-Lib C library
        RUN cd /tmp && \
            wget -q http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz && \
            tar -xzf ta-lib-0.4.0-src.tar.gz && \
            cd ta-lib && \
            ./configure --prefix=/usr && \
            make -j$(nproc) && \
            make install && \
            ldconfig && \
            cd / && \
            rm -rf /tmp/ta-lib*
        
        # Install Python packages
        RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
            pip install --no-cache-dir numpy && \
            pip install --no-cache-dir TA-Lib && \
            pip install --no-cache-dir \
                requests \
                pandas \
                python-dotenv \
                scikit-learn \
                scipy
        
        WORKDIR /app
        COPY . .
        
        # Verify TA-Lib installation
        RUN python -c "import talib; print('âœ… TA-Lib ready:', talib.__version__)"
        
        CMD ["python", "mexc_bot.py"]
        EOF
        
    - name: Build Docker image
      run: |
        echo "ðŸ³ Building Docker image with TA-Lib..."
        docker build -t mexc-bot:latest .
        
    - name: Run bot in Docker
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸš€ Starting Enhanced MEXC Bot in Docker..."
        timeout 25m docker run --rm \
          -e TELEGRAM_TOKEN="$TELEGRAM_TOKEN" \
          -e TELEGRAM_CHAT_ID="$TELEGRAM_CHAT_ID" \
          mexc-bot:latest || echo "Bot completed or timeout reached"
